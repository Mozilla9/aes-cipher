/******************************************************************************/
/*  Class HEXFILE                                                             */
/*  PO: S. Maslyakov, rusoil.9@gmail.com                                      */
/*                                                                            */
/*  Revision:     1.2                                                         */
/*  Date:         2011/02/03 13:14:33                                         */
/******************************************************************************/


#ifndef __HEXFILE_H
#define __HEXFILE_H


#include "hex_def.h"


//==============================================================================
//  Class HEXFILE
//==============================================================================
class HEXFILE
{
    //==========================================================================
    // App: Constructor
    //==========================================================================
    public: HEXFILE();
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Test file end
    //==========================================================================
    public: bool_t IsFileEnd() const {
        return FlgHex.FlgFileEnd;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Set flg file end
    //==========================================================================
    public: void SetFlgFileEnd() {
        FlgHex.FlgFileEnd = TRUE_T;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Set lower segment addr
    //==========================================================================
    public: void SetLowCurrAddr(const uint32_t _addr) {
        HexTools.CurrAddr |= (_addr & 0x0000FFFF);
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Set upper segment addr
    //==========================================================================
    public: void SetUpperCurrAddr(uint32_t _addr) {
        HexTools.CurrAddr |= (_addr & 0xFFFF0000);
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Make full addr
    //==========================================================================
    public: uint32_t ConversDataToFullAddr();
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Make upper addr
    //==========================================================================
    public: uint32_t ConversDataToUpperAddr();
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Make lower addr
    //==========================================================================
    public: uint32_t ConversDataToLowAddr();
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Get addr
    //==========================================================================
    public: uint32_t GetCurrAddr() const {
        return HexTools.CurrAddr;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Prepare string read
    //==========================================================================
    public: void PrepareReadingNewString();
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Set header
    //==========================================================================
    public: void SetRecHeader(uint8_t * _pSrc);
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Get datalen
    //==========================================================================
    public: uint32_t GetFwDataCount() const {
        return HexTools.DataCount;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Get crc
    //==========================================================================
    public: uint32_t GetFwCrc() const {
        return (0 - HexTools.FwCrc);
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Get reclen
    //==========================================================================
    public: uint32_t GetReclen() const {
        return ((uint32_t)RecHeader.Reclen);
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Get addr offset
    //==========================================================================
    public: uint32_t GetOffset() const {
        return ((uint32_t)RecHeader.Offset);
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Get rec type
    //==========================================================================
    public: __TYPEREC_HEX GetTypeRec() const {
        return RecHeader.TypeRec;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Write data
    //==========================================================================
    public: void WriteDataToRowBuff(uint8_t * _pSrc);
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Test addr offset
    //==========================================================================
    public: bool_t ValidateOffset() const {
        return (RecHeader.Offset < ((uint16_t)HexTools.CurrAddr)) ? FALSE_T : TRUE_T;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Compare addr offset w addr
    //==========================================================================
    public: bool_t CmpOffsetAndCurrAddr() const {
        return (RecHeader.Offset == ((uint16_t)HexTools.CurrAddr)) ? TRUE_T : FALSE_T;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Get byte
    //==========================================================================
    public: uint8_t GetCipherByte(const uint32_t _ind) const {
        return Sbuf.Data[_ind];
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Clear cipher buff
    //==========================================================================
    public: void ClearCipherBuff() {
        Sbuf.DataLen = 0;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Get datalen
    //==========================================================================
    public: uint32_t GetCipherDataLen() const {
        return Sbuf.DataLen;
    }
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: 
    //==========================================================================
    public: bool_t FillBuffVoidData(const uint32_t _len);
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: 
    //==========================================================================
    public: bool_t WriteBuffData();
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Last data ciphering
    //==========================================================================
    public: bool_t FinalCiphering();
    //==========================================================================
    //==========================================================================


    //==========================================================================
    // App: Init hw
    //==========================================================================
    // Получить вектор
    private: void GetIv(uint8_t * _pIv);
    //==========================================================================
    //==========================================================================

    private: __BUFF_TOOLS_HEX Fbuf;
    private: __BUFF_TOOLS_HEX Sbuf;
    private: __PARSING_TOOLS_HEX HexTools;
    private: __RECLEN_HEADER_HEX RecHeader;
    private: __FLG_HEX FlgHex;
    private: __ENCRYPT_TOOLS_HEX AesTools;
};
//==============================================================================
//==============================================================================


#endif